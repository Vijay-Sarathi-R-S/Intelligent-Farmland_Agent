<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Verdex â€” Enterprise Farmland Intelligence</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/gsap.min.js"></script>

<style>
*{margin:0;padding:0;box-sizing:border-box}

body{
font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;
background:radial-gradient(circle at top,#0f172a,#020617 80%);
color:#e5e7eb;
min-height:100vh;
overflow-x:hidden;
}

/* 3D canvas */
#bg3d{
position:fixed;
top:0;
left:0;
z-index:-2;
}

/* dim layer for blending */
.bg-dim{
position:fixed;
inset:0;
background:radial-gradient(circle at center,transparent 20%,rgba(2,6,23,.75) 80%);
z-index:-1;
}

/* NAVBAR */
.navbar{
backdrop-filter:blur(20px);
background:rgba(255,255,255,.05);
border-bottom:1px solid rgba(255,255,255,.08);
padding:1rem 2rem;
display:flex;
justify-content:space-between;
align-items:center;
}
.logo{color:#38bdf8;font-weight:bold;font-size:1.5rem;text-decoration:none}

/* LAYOUT */
.container{max-width:1300px;margin:2rem auto;padding:0 2rem}

.header{
backdrop-filter:blur(30px);
background:rgba(255,255,255,.05);
border:1px solid rgba(255,255,255,.08);
padding:2rem;
border-radius:16px;
margin-bottom:2rem;
display:flex;
justify-content:space-between;
}

/* BUTTONS */
.btn{
background:linear-gradient(135deg,#38bdf8,#6366f1);
border:none;color:white;padding:.7rem 1.4rem;border-radius:8px;
cursor:pointer;transition:.3s;
}
.btn:hover{transform:translateY(-2px)}
.btn-secondary{background:linear-gradient(135deg,#22c55e,#4ade80)}
.btn-danger{background:linear-gradient(135deg,#ef4444,#dc2626)}

/* GRID */
.fields-grid{
display:grid;
grid-template-columns:repeat(auto-fill,minmax(350px,1fr));
gap:1.5rem;
}

/* GLASS CARD */
.field-card{
position:relative;
backdrop-filter:blur(28px) saturate(140%);
background:linear-gradient(145deg,rgba(15,23,42,.75),rgba(30,41,59,.55));
border:1px solid rgba(148,163,184,.15);
border-radius:18px;
padding:1.6rem;
box-shadow:0 10px 40px rgba(0,0,0,.45),
inset 0 0 40px rgba(56,189,248,.04);
transition:.4s;
transform-style:preserve-3d;
}
.field-card::before{
content:"";
position:absolute;inset:0;border-radius:18px;
background:linear-gradient(120deg,transparent,rgba(56,189,248,.08),transparent);
opacity:0;transition:.4s;
}
.field-card:hover::before{opacity:1}

/* RISK */
.risk-badge{padding:.25rem .75rem;border-radius:20px;font-size:.8rem;font-weight:bold}
.risk-Low{background:#052e16;color:#4ade80}
.risk-Medium{background:#3f2a00;color:#facc15}
.risk-High{background:#450a0a;color:#f87171}

/* MODAL */
.modal{
display:none;position:fixed;inset:0;
background:rgba(0,0,0,.7);
justify-content:center;align-items:center;z-index:1000;
}
.modal-content{
backdrop-filter:blur(30px);
background:rgba(255,255,255,.05);
border:1px solid rgba(255,255,255,.1);
padding:2rem;border-radius:16px;width:90%;max-width:600px;
}

/* INPUT */
input{
width:100%;padding:.7rem;margin-bottom:1rem;
background:rgba(255,255,255,.05);
border:1px solid rgba(255,255,255,.1);
border-radius:8px;color:white;
}

/* PROGRESS */
.progress-bar{
width:100%;height:8px;background:#111827;border-radius:10px;overflow:hidden;margin-top:10px;
}
.progress-fill{
height:100%;
background:linear-gradient(90deg,#38bdf8,#6366f1);
transition:width .3s;
}
.loading{text-align:center;padding:2rem}
.error{background:#450a0a;padding:1rem;border-radius:10px}
.report{white-space:pre-wrap;font-family:monospace}
</style>
</head>

<body>

<canvas id="bg3d"></canvas>
<div class="bg-dim"></div>

<nav class="navbar">
<a href="/" class="logo">Verdex</a>
<button class="btn" onclick="showAddModal()">+ Add Field</button>
</nav>

<div class="container">
<div class="header">
<div>
<h1>Farmland Intelligence</h1>
<p style="opacity:.7">Enterprise Satellite Monitoring Platform</p>
</div>
<div id="fieldCount">0 fields</div>
</div>

<div id="fieldsContainer" class="fields-grid">
<div class="loading">Loading fields...</div>
</div>
</div>

<!-- ADD FIELD -->
<div id="addModal" class="modal">
<div class="modal-content">
<h2>Add Field</h2>
<input id="fieldName" placeholder="Field name">
<input id="latitude" type="number" step="any" placeholder="Latitude">
<input id="longitude" type="number" step="any" placeholder="Longitude">
<input id="acres" type="number" step="0.1" placeholder="Acres">
<input id="cropType" placeholder="Crop type">
<button class="btn" onclick="addField()">Add</button>
<button class="btn" onclick="hideAddModal()">Cancel</button>
</div>
</div>

<!-- ANALYSIS -->
<div id="analysisModal" class="modal">
<div class="modal-content">
<h2 id="analysisTitle"></h2>
<div id="analysisContent"></div>
<button class="btn" onclick="hideAnalysisModal()">Close</button>
</div>
</div>

<script>

/* =============================
   FIELD SYSTEM (UNCHANGED)
============================= */

let fields=[];
document.addEventListener('DOMContentLoaded',loadFields);

async function loadFields(){
try{
const res=await fetch('/api/fields');
const data=await res.json();
if(data.success){
fields=data.fields;
displayFields();
document.getElementById('fieldCount').textContent=`${fields.length} fields`;
}
}catch{showError('Failed to load fields')}
}

function displayFields(){
const container=document.getElementById('fieldsContainer');

if(fields.length===0){
container.innerHTML='<div class="loading">No fields yet</div>';
return;
}

container.innerHTML=fields.map(field=>`
<div class="field-card" data-id="${field.id}">
<div style="font-size:1.2rem;font-weight:600">${field.name}</div>
<div style="opacity:.6">${field.latitude.toFixed(4)}, ${field.longitude.toFixed(4)}</div>

<div style="margin-top:8px">Acres: ${field.acres}</div>
<div>Crop: ${field.crop_type || 'Unknown'}</div>

<div style="margin-top:10px">
Risk:
<span class="risk-badge risk-${field.risk || 'Medium'}" id="risk-${field.id}">
${field.risk || 'Pending'}
</span>
</div>

<div style="margin-top:12px;display:flex;gap:6px">
<button class="btn-secondary" onclick="analyzeField('${field.id}')" id="analyze-${field.id}">Analyze</button>
<button class="btn" onclick="viewReport('${field.id}')">Report</button>
<button class="btn" onclick="downloadPDF('${field.id}')">PDF</button>
<button class="btn-danger" onclick="deleteField('${field.id}')">Delete</button>
</div>

<div id="progress-${field.id}" style="display:none">
<div class="progress-bar">
<div class="progress-fill" id="progress-fill-${field.id}"></div>
</div>
<div id="progress-text-${field.id}" style="font-size:.8rem;margin-top:4px"></div>
</div>

</div>
`).join('');
}

/* =============================
   ENTERPRISE ANALYSIS LOADER
============================= */

async function analyzeField(fieldId){

const btn=document.getElementById(`analyze-${fieldId}`);
const progressBox=document.getElementById(`progress-${fieldId}`);
const fill=document.getElementById(`progress-fill-${fieldId}`);
const text=document.getElementById(`progress-text-${fieldId}`);

btn.disabled=true;
progressBox.style.display='block';

function set(p,msg){
fill.style.width=p+"%";
text.textContent=msg;
}

set(10,"Connecting to satellite...");
await sleep(500);

set(30,"Fetching NDVI imagery...");
await sleep(700);

set(55,"Downloading weather model...");
await sleep(800);

try{

const res=await fetch(`/api/fields/${fieldId}/analyze`,{
method:"POST",
headers:{'Content-Type':'application/json'},
body:JSON.stringify({})
});

set(80,"AI risk modelling...");
await sleep(900);

const data=await res.json();

if(data.success){
set(100,"Analysis complete");

const badge=document.getElementById(`risk-${fieldId}`);
badge.textContent=data.analysis.overall_risk;
badge.className=`risk-badge risk-${data.analysis.overall_risk}`;

setTimeout(()=>{
showAnalysisResults(data.analysis);
progressBox.style.display='none';
btn.disabled=false;
},600);
}

}catch(e){
set(0,"Analysis failed");
setTimeout(()=>{
progressBox.style.display='none';
btn.disabled=false;
},1500);
}
}

function sleep(ms){return new Promise(r=>setTimeout(r,ms))}

/* =============================
   THREE JS TERRAIN
============================= */

const canvas=document.getElementById('bg3d');
const scene=new THREE.Scene();

const camera=new THREE.PerspectiveCamera(75,window.innerWidth/window.innerHeight,.1,1000);
camera.position.set(0,20,35);

const renderer=new THREE.WebGLRenderer({canvas,alpha:true,antialias:true});
renderer.setSize(window.innerWidth,window.innerHeight);

/* terrain */
const terrainGeo=new THREE.PlaneGeometry(120,120,120,120);
const terrainMat=new THREE.MeshStandardMaterial({
color:0x0ea5e9,wireframe:true,transparent:true,opacity:.15
});
const terrain=new THREE.Mesh(terrainGeo,terrainMat);
terrain.rotation.x=-Math.PI/2;
scene.add(terrain);

/* lights */
scene.add(new THREE.AmbientLight(0x1e293b,2));
const light=new THREE.PointLight(0x38bdf8,2,200);
light.position.set(20,30,20);
scene.add(light);

/* animate terrain */
const pos=terrain.geometry.attributes.position;

function animateTerrain(t){
for(let i=0;i<pos.count;i++){
const x=pos.getX(i);
const y=pos.getY(i);
const wave=Math.sin(x*.15+t*.0015)+Math.cos(y*.15+t*.0012);
pos.setZ(i,wave*.6);
}
pos.needsUpdate=true;
}

function animate(time){
requestAnimationFrame(animate);
animateTerrain(time);
terrain.rotation.z+=.0004;
renderer.render(scene,camera);
}
animate();

window.addEventListener('resize',()=>{
renderer.setSize(window.innerWidth,window.innerHeight);
camera.aspect=window.innerWidth/window.innerHeight;
camera.updateProjectionMatrix();
});

/* =============================
   MODALS
============================= */
function showAddModal(){
document.getElementById('addModal').style.display='flex';
gsap.from(".modal-content",{scale:.7,opacity:0,duration:.35});
}
function hideAddModal(){document.getElementById('addModal').style.display='none'}
function hideAnalysisModal(){document.getElementById('analysisModal').style.display='none'}

</script>
</body>
</html>
